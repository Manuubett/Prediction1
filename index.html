<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Soccer Predictor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .match-card {
      transition: transform 0.2s;
    }
    .match-card:hover {
      transform: translateY(-3px);
    }
    .progress-bar {
      transition: width 0.5s ease;
    }
    .prediction-card {
      border-left: 4px solid #0d6efd;
    }
    #predictionResult {
      transition: all 0.3s ease;
    }
  </style>
</head>
<body class="bg-light py-4">
  <div class="container">
    <h1 class="text-center mb-4">⚽ Advanced Soccer Predictor</h1>
    
    <!-- Match Inputs -->
    <div class="row mb-4">
      <div class="col-12 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Enter Match Data (Format: TeamA, ScoreA, ScoreB, TeamB)</h5>
            <div class="row">
              <!-- 5 input fields -->
              <div class="col-md-4 mb-2">
                <textarea id="matchInput1" class="form-control" rows="4" placeholder="Team A&#10;2&#10;1&#10;Team B"></textarea>
              </div>
              <div class="col-md-4 mb-2">
                <textarea id="matchInput2" class="form-control" rows="4"></textarea>
              </div>
              <div class="col-md-4 mb-2">
                <textarea id="matchInput3" class="form-control" rows="4"></textarea>
              </div>
              <div class="col-md-4 mb-2">
                <textarea id="matchInput4" class="form-control" rows="4"></textarea>
              </div>
              <div class="col-md-4 mb-2">
                <textarea id="matchInput5" class="form-control" rows="4"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-md-4 mb-2">
        <button class="btn btn-success w-100" onclick="loadAllMatches()">📥 Load Matches</button>
      </div>
      <div class="col-md-4 mb-2">
        <button class="btn btn-primary w-100" onclick="predictMatch()">🔮 Predict Match</button>
      </div>
      <div class="col-md-4 mb-2">
        <button class="btn btn-danger w-100" onclick="resetSystem()">🔄 Reset</button>
      </div>
    </div>

    <!-- Team Selection -->
    <div class="row mb-4">
      <div class="col-md-5">
        <label class="form-label">Home Team</label>
        <select class="form-select" id="teamA"></select>
      </div>
      <div class="col-md-2 text-center align-self-end pb-2">
        <span class="fw-bold fs-4">vs</span>
      </div>
      <div class="col-md-5">
        <label class="form-label">Away Team</label>
        <select class="form-select" id="teamB"></select>
      </div>
    </div>

    <!-- Prediction Result -->
    <div id="predictionResult" class="card shadow mb-4 d-none">
      <div class="card-body">
        <!-- Content will be generated by JavaScript -->
      </div>
    </div>

    <!-- Match History -->
    <div class="card shadow">
      <div class="card-header bg-white">
        <h5 class="mb-0">📋 Match History</h5>
      </div>
      <div class="card-body">
        <div id="matchHistory" class="row"></div>
      </div>
    </div>
  </div>
<script>
  // Global variables
  let matchData = [];
  const DEFAULT_AVG_FOR = 1.2;
  const DEFAULT_AVG_AGAINST = 1.0;
  const RECENT_MATCHES_LIMIT = 10;
  const HOME_ADVANTAGE = 0.25;

  // Parse matches from text input
  function parseMatches(text) {
    const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
    const parsed = [];
    for (let i = 0; i <= lines.length - 4; i += 4) {
      const team1 = lines[i];
      const score1 = parseInt(lines[i + 1]);
      const score2 = parseInt(lines[i + 2]);
      const team2 = lines[i + 3];
      if (team1 && team2 && !isNaN(score1) && !isNaN(score2)) {
        parsed.push({
          team1, 
          score1, 
          team2, 
          score2,
          date: new Date()
        });
      }
    }
    return parsed;
  }

  // Load matches from all input fields
  function loadAllMatches() {
    matchData = [];
    
    for (let i = 1; i <= 5; i++) {
      const input = document.getElementById(`matchInput${i}`).value.trim();
      if (input) {
        const newMatches = parseMatches(input);
        matchData.push(...newMatches);
      }
    }

    if (matchData.length === 0) {
      alert("❌ Please enter valid match data in at least one field.");
      return;
    }

    matchData.sort((a, b) => b.date - a.date);
    updateTeamSelects();
    updateMatchHistory();
    alert(`✅ Loaded ${matchData.length} matches. Select teams to predict.`);
  }

  // Update team dropdowns
  function updateTeamSelects() {
    const teams = [...new Set(matchData.flatMap(m => [m.team1, m.team2]))].sort();
    const teamASelect = document.getElementById("teamA");
    const teamBSelect = document.getElementById("teamB");
    
    teamASelect.innerHTML = teamBSelect.innerHTML = '';
    teams.forEach(team => {
      teamASelect.add(new Option(team, team));
      teamBSelect.add(new Option(team, team));
    });
  }

  // Update match history display
  function updateMatchHistory() {
    const historyContainer = document.getElementById("matchHistory");
    historyContainer.innerHTML = '';
    
    const recentMatches = matchData.slice(0, 15);
    
    recentMatches.forEach((match, index) => {
      const matchCard = document.createElement("div");
      matchCard.className = "col-md-6 col-lg-4 mb-3";
      matchCard.innerHTML = `
        <div class="card match-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">${match.team1} vs ${match.team2}</h6>
              <small class="text-muted">${match.date.toLocaleTimeString()}</small>
            </div>
            <div class="text-center display-5">
              ${match.score1} - ${match.score2}
            </div>
          </div>
        </div>
      `;
      historyContainer.appendChild(matchCard);
    });
  }

  // Get recent matches for a team
  function getRecentMatches(team, limit = RECENT_MATCHES_LIMIT) {
    return matchData
      .filter(m => m.team1 === team || m.team2 === team)
      .slice(0, limit);
  }

  // Calculate team statistics
  function getTeamStats(team) {
    const matches = getRecentMatches(team);
    if (matches.length === 0) return {
      avgFor: DEFAULT_AVG_FOR,
      avgAgainst: DEFAULT_AVG_AGAINST
    };

    let goalsFor = 0, goalsAgainst = 0;
    matches.forEach(match => {
      if (match.team1 === team) {
        goalsFor += match.score1;
        goalsAgainst += match.score2;
      } else {
        goalsFor += match.score2;
        goalsAgainst += match.score1;
      }
    });

    return {
      avgFor: Math.max(0.5, goalsFor / matches.length),
      avgAgainst: Math.max(0.5, goalsAgainst / matches.length)
    };
  }

  // Poisson distribution calculation
  function poisson(mean, k) {
    return (Math.pow(mean, k) * Math.exp(-mean)) / factorial(k);
  }

  function factorial(n) {
    return n <= 1 ? 1 : n * factorial(n - 1);
  }

  // Predict match outcomes
  function predictMatch() {
    const teamA = document.getElementById("teamA").value;
    const teamB = document.getElementById("teamB").value;

    if (!teamA || !teamB || teamA === teamB) {
      alert("⚠️ Please select two different teams.");
      return;
    }

    // Get basic stats
    const statsA = getTeamStats(teamA);
    const statsB = getTeamStats(teamB);
    
    // Adjust for home advantage
    const isTeamAHome = matchData.some(m => m.team1 === teamA && m.team2 === teamB);
    const homeAdj = isTeamAHome ? HOME_ADVANTAGE : -HOME_ADVANTAGE;
    
    // Calculate expected goals
    const lambdaA = (statsA.avgFor + statsB.avgAgainst) / 2 + homeAdj;
    const lambdaB = (statsB.avgFor + statsA.avgAgainst) / 2 - homeAdj/2;
    
    // Generate score probabilities
    const scoreProbabilities = [];
    for (let i = 0; i <= 5; i++) {
      for (let j = 0; j <= 5; j++) {
        scoreProbabilities.push({
          score: `${i}-${j}`,
          probability: poisson(lambdaA, i) * poisson(lambdaB, j) * 100
        });
      }
    }
    
    // Sort by probability
    scoreProbabilities.sort((a, b) => b.probability - a.probability);
    
    // Calculate outcome probabilities
    const homeWinProb = scoreProbabilities
      .filter(s => parseInt(s.score.split('-')[0]) > parseInt(s.score.split('-')[1]))
      .reduce((sum, s) => sum + s.probability, 0);
      
    const drawProb = scoreProbabilities
      .filter(s => parseInt(s.score.split('-')[0]) === parseInt(s.score.split('-')[1]))
      .reduce((sum, s) => sum + s.probability, 0);
      
    const awayWinProb = scoreProbabilities
      .filter(s => parseInt(s.score.split('-')[0]) < parseInt(s.score.split('-')[1]))
      .reduce((sum, s) => sum + s.probability, 0);

    // Determine possible winner
    let possibleWinner, winnerConfidence;
    if (homeWinProb >= awayWinProb && homeWinProb >= drawProb) {
      possibleWinner = teamA;
      winnerConfidence = homeWinProb > 60 ? "High" : homeWinProb > 45 ? "Medium" : "Low";
    } else if (awayWinProb >= homeWinProb && awayWinProb >= drawProb) {
      possibleWinner = teamB;
      winnerConfidence = awayWinProb > 60 ? "High" : awayWinProb > 45 ? "Medium" : "Low";
    } else {
      possibleWinner = "Draw";
      winnerConfidence = drawProb > 60 ? "High" : drawProb > 45 ? "Medium" : "Low";
    }

    // Calculate market predictions
    const over15 = (1 - (poisson(lambdaA, 0) * poisson(lambdaB, 0) + 
                     poisson(lambdaA, 1) * poisson(lambdaB, 0) + 
                     poisson(lambdaA, 0) * poisson(lambdaB, 1))) * 100;
    
    const over25 = (1 - (poisson(lambdaA, 0) * poisson(lambdaB, 0) + 
                     poisson(lambdaA, 1) * poisson(lambdaB, 0) + 
                     poisson(lambdaA, 0) * poisson(lambdaB, 1) +
                     poisson(lambdaA, 1) * poisson(lambdaB, 1) +
                     poisson(lambdaA, 2) * poisson(lambdaB, 0) +
                     poisson(lambdaA, 0) * poisson(lambdaB, 2))) * 100;
    
    const ggProbability = (1 - (poisson(lambdaA, 0) + poisson(lambdaB, 0) - 
                         poisson(lambdaA, 0) * poisson(lambdaB, 0))) * 100;
    
    // Double chance calculations
    const doubleChance1X = homeWinProb + drawProb;
    const doubleChance12 = homeWinProb + awayWinProb;
    const doubleChanceX2 = drawProb + awayWinProb;

    // Display results
    const resultBox = document.getElementById("predictionResult");
    resultBox.classList.remove("d-none");
    resultBox.innerHTML = `
      <h4 class="mb-4">📊 Prediction: ${teamA} vs ${teamB}</h4>
      
      <!-- Possible Winner Section -->
      <div class="card mb-4 border-success">
        <div class="card-body">
          <h5 class="text-success">🏆 Possible Winner</h5>
          <div class="d-flex align-items-center mb-2">
            <div class="fs-3 me-3">${possibleWinner}</div>
            <span class="badge bg-${winnerConfidence === 'High' ? 'success' : winnerConfidence === 'Medium' ? 'warning' : 'danger'}">
              ${winnerConfidence} Confidence
            </span>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="d-flex justify-content-between">
                <span>${teamA} Win:</span>
                <strong>${homeWinProb.toFixed(1)}%</strong>
              </div>
              <div class="progress mt-1" style="height: 8px">
                <div class="progress-bar" style="width: ${homeWinProb}%"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex justify-content-between">
                <span>Draw:</span>
                <strong>${drawProb.toFixed(1)}%</strong>
              </div>
              <div class="progress mt-1" style="height: 8px">
                <div class="progress-bar bg-warning" style="width: ${drawProb}%"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex justify-content-between">
                <span>${teamB} Win:</span>
                <strong>${awayWinProb.toFixed(1)}%</strong>
              </div>
              <div class="progress mt-1" style="height: 8px">
                <div class="progress-bar bg-danger" style="width: ${awayWinProb}%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Double Chance Section -->
      <div class="card mb-4 border-primary">
        <div class="card-body">
          <h5 class="text-primary">🔀 Double Chance Markets</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <h6>${teamA} or Draw</h6>
                  <div class="display-5 text-primary">${doubleChance1X.toFixed(1)}%</div>
                  <div class="progress mt-2" style="height: 8px">
                    <div class="progress-bar bg-primary" style="width: ${doubleChance1X}%"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <h6>${teamA} or ${teamB}</h6>
                  <div class="display-5 text-info">${doubleChance12.toFixed(1)}%</div>
                  <div class="progress mt-2" style="height: 8px">
                    <div class="progress-bar bg-info" style="width: ${doubleChance12}%"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <h6>Draw or ${teamB}</h6>
                  <div class="display-5 text-primary">${doubleChanceX2.toFixed(1)}%</div>
                  <div class="progress mt-2" style="height: 8px">
                    <div class="progress-bar bg-primary" style="width: ${doubleChanceX2}%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Goal Markets Section -->
      <div class="card mb-4">
        <div class="card-body">
          <h5>⚽ Goal Markets</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="d-flex justify-content-between">
                <strong>Over 1.5 Goals:</strong>
                <span class="badge bg-success">${over15.toFixed(1)}%</span>
              </div>
              <div class="progress mt-1" style="height: 10px">
                <div class="progress-bar bg-success" style="width: ${over15}%"></div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-flex justify-content-between">
                <strong>Over 2.5 Goals:</strong>
                <span class="badge bg-info">${over25.toFixed(1)}%</span>
              </div>
              <div class="progress mt-1" style="height: 10px">
                <div class="progress-bar bg-info" style="width: ${over25}%"></div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-flex justify-content-between">
                <strong>Both Teams Score (GG):</strong>
                <span class="badge bg-warning">${ggProbability.toFixed(1)}%</span>
              </div>
              <div class="progress mt-1" style="height: 10px">
                <div class="progress-bar bg-warning" style="width: ${ggProbability}%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Correct Score Section -->
      <div class="card">
        <div class="card-body">
          <h5>🎯 Most Probable Correct Scores</h5>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Score</th>
                  <th>Probability</th>
                  <th>Payout Estimate</th>
                </tr>
              </thead>
              <tbody>
                ${scoreProbabilities.slice(0, 6).map(score => `
                  <tr>
                    <td>${score.score}</td>
                    <td>${score.probability.toFixed(2)}%</td>
                    <td>${(100/score.probability).toFixed(2)}x</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="mt-3 small text-muted">
        <p>ℹ️ Predictions based on Poisson distribution. Home advantage of ${HOME_ADVANTAGE} goals applied.</p>
      </div>
    `;
  }

  // Reset system
  function resetSystem() {
    matchData = [];
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`matchInput${i}`).value = "";
    }
    document.getElementById("teamA").innerHTML = "";
    document.getElementById("teamB").innerHTML = "";
    document.getElementById("predictionResult").classList.add("d-none");
    document.getElementById("matchHistory").innerHTML = "";
    alert("System has been reset. Ready for new match data.");
  }
</script>
</body>
</html>
